# Изменения в системе загрузки изображений для Smile

## Описание изменений

Модифицирована система загрузки изображений в админ-панели для раздела Smiles (`/admin/smiles/edit/<id>` и `/admin/smiles/new`). 

### Что было изменено:

1. **UploaderSmile класс** (`lib/uploader-smiles.rb`):
   - Убраны дополнительные версии (`:tn` и `:square_blur`)
   - Обработка `make_square_with_blur` применяется к основному файлу
   - Реализована генерация уникальных имен файлов
   - Оригинальный файл не сохраняется - сохраняется только обработанный результат

### Новая логика работы:

1. **При загрузке изображения:**
   - Изображение проходит через middleware CarrierWave
   - Применяется обработка `make_square_with_blur` (создание квадратного изображения с размытым фоном)
   - Генерируется уникальное имя файла в формате: `smile_<unix_timestamp>.<extension>`
   - Результат сохраняется на диск в директорию `public/uploads/smiles/`
   - Имя файла записывается в поле `smiles.images` в базе данных

2. **Генерация имени файла:**
   ```ruby
   def filename
     if original_filename
       extension = File.extname(original_filename).downcase
       extension = '.jpg' if extension.empty? || !%w(.jpg .jpeg .gif .png).include?(extension)
       @name ||= "smile_#{Time.now.to_i}#{extension}"
     end
   end
   ```

3. **Обработка изображения:**
   - Если изображение уже квадратное - обработка пропускается
   - Для неквадратных изображений:
     - Создается размытый фон из увеличенного оригинала
     - Оригинал накладывается по центру на размытый фон
     - Результат имеет квадратные пропорции

### Примеры генерируемых имен:

```
photo.jpg -> smile_1761707158.jpg
image.jpeg -> smile_1761707159.jpeg
picture.png -> smile_1761707160.png
file.gif -> smile_1761707161.gif
no_extension -> smile_1761707162.jpg
bad.txt -> smile_1761707163.jpg (неподдерживаемые форматы -> .jpg)
```

### Директории:

- **Корневая директория:** `public/`
- **Директория загрузки:** `public/uploads/smiles/`
- **Временная директория:** `tmp/`

### Поддерживаемые форматы:

- `.jpg`, `.jpeg`, `.gif`, `.png`
- Неподдерживаемые форматы автоматически конвертируются в `.jpg`

### Оптимизация:

- Применяется сжатие с качеством 50%
- Единственный файл сохраняется (экономия дискового пространства)
- Уникальные имена предотвращают конфликты

### Измененные файлы:

1. **`lib/uploader-smiles.rb`** - основной uploader класс
2. **`app/helpers/seo_helper.rb`** - обновлена функция `get_smile_image_path`

### Обратная совместимость:

Изменения не затрагивают:
- Существующие загруженные файлы
- Логику отображения в админ-панели и на фронтенде
- Структуру базы данных (MySQL поле `smiles.images`)
- API endpoints
- Методы CarrierWave (`images_identifier`, `images.url`, etc.)

Существующие файлы продолжат работать как обычно, новые файлы будут создаваться по новой схеме.

### Коммиты:

1. **e6bb77a** - modify smile image upload to save processed result with unique filename
2. **c3ac0b4** - update seo_helper to work with new smile image upload system

### Тестирование:

Пройдены интеграционные тесты:
- Генерация уникальных имен ✔️
- Функция get_smile_image_path ✔️
- Schema.org microdata генерация ✔️
- Обработка крайних случаев ✔️
- Обратная совместимость ✔️
