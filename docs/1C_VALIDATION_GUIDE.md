# Валидация данных в 1С интеграции

## Обзор

В интеграции с 1С добавлена комплексная система валидации входящих данных и файлов для обеспечения безопасности и стабильности системы.

## Типы валидации

### 1. Валидация структуры ответа 1С

**Функция:** `validate_1c_response_structure(response_data, log)`

**Проверяет:**
- Наличие обязательных полей: `etag`, `data`, `pending`, `updated_at`
- Тип данных поля `data` (должен быть массивом)
- Корректность поля `pending` (должно быть числом)

### 2. Валидация данных товара

**Функция:** `validate_product_data(product_data, index, log)`

#### Обязательные поля:
- `product_id` (String, до 100 символов)
- `title` (String, до 500 символов) 
- `text` (String, до 10,000 символов)
- `categories` (String, до 1,000 символов)
- `price` (String/Number, до 999,999.99)

#### Опциональные поля:
- `size`, `package`, `components` (String)
- `color`, `recipient`, `reason` (String)
- `price_1990`, `price_2890`, `price_3790` (Number)
- `discounts`, `main_image`, `all_images` (Array/Hash)

#### Специальные проверки:
- **Product ID**: только буквы, цифры, дефисы, подчеркивания
- **Categories**: разделены точкой с запятой, не пустые
- **Title**: должен содержать тип комплекта в скобках

### 3. Валидация изображений

**Функция:** `validate_image_data(all_images, id_1C, log)`

**Проверяет:**
- Структуру данных (массив объектов)
- Максимальное количество изображений (50)
- Для каждого изображения:
  - Наличие валидного URL
  - Корректность HTTP/HTTPS URL
  - Поддерживаемые форматы: `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.webp`
  - Безопасность имени файла (защита от path traversal)

### 4. Валидация файлов

**Функция:** `validate_file_safety(file_path, max_size_mb)`

**Проверяет:**
- Существование файла
- Размер файла (по умолчанию до 10МБ)
- MIME тип изображения через MiniMagick
- Поддерживаемые форматы: JPEG, PNG, GIF, BMP, WEBP
- Разрешение изображения (максимум 5000x5000)

## Точки валидации

### В эндпоинте `/api/1c_notify_update`:

1. **JSON парсинг** - проверка корректности JSON ответа
2. **Структура ответа** - валидация полей ответа 1С
3. **Отрицательные значения** - проверка `pending` на отрицательные значения

### В `crud_product_complects_transaction`:

1. **Данные товара** - полная валидация каждого товара перед обработкой
2. **Пропуск некорректных** - некорректные товары пропускаются с логированием

### В `processing_all_images`:

1. **Структура изображений** - валидация перед обработкой
2. **Размер при скачивании** - проверка размера до 10МБ
3. **Таймауты HTTP** - 10сек на подключение, 30сек на чтение
4. **Безопасность файла** - проверка после сохранения
5. **Обработка ошибок** - удаление некорректных файлов

## Обновленные возможности

### HTTP запросы с таймаутами:
```ruby
http.open_timeout = 10
http.read_timeout = 30
```

### Безопасная обработка ошибок:
- Автоматическое удаление некорректных файлов
- Детальное логирование всех проблем
- Graceful handling ошибок сети и таймаутов

### Производительность:
- Валидация происходит до тяжелых операций
- Ранний выход при некорректных данных
- Подробная статистика ошибок

## Логирование

Все этапы валидации логируются с префиксами:
- `[VALIDATION OK]` - успешная валидация
- `[VALIDATION ERROR]` - ошибка валидации
- `[ITEM N]` - привязка к конкретному товару

## Конфигурация

### Лимиты (можно настроить в коде):
- Максимум изображений на товар: 50
- Максимальный размер файла: 10МБ
- Максимальное разрешение: 5000x5000
- Таймауты: 10с подключение, 30с чтение

### Поддерживаемые форматы:
- **Входящие:** JPG, JPEG, PNG, GIF, BMP, WEBP
- **Исходящие:** WebP (конвертация) + миниатюры

## Мониторинг

Рекомендуется отслеживать в логах:
- Количество `[VALIDATION ERROR]` записей
- Частоту timeout ошибок
- Статистику пропущенных товаров
- Проблемы с размерами/форматами изображений
