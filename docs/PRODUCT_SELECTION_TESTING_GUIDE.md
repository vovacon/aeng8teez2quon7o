# Руководство по тестированию функции выбора товаров для отзывов

## Описание функциональности

Добавлена возможность связывать отзывы с конкретными товарами из заказов через поле `order_products_base_id` в таблице `smiles`.

## Что изменилось

### 1. Контроллер admin/controllers/smiles.rb
- ✅ Добавлено поле `order_products_base_id` в список разрешенных параметров для методов `create` и `update`
- ✅ API эндпоинт `/admin/smiles/order_products/:order_id` возвращает товары с полем `base_id`

### 2. Форма admin/views/smiles/_form.haml
- ✅ Добавлено скрытое поле `order_products_base_id` для передачи выбранного товара
- ✅ JavaScript автоматически заполняет скрытое поле при выборе товара радиокнопкой
- ✅ Первый товар выбирается автоматически при загрузке списка
- ✅ Поле очищается при скрытии информации о заказе

### 3. Модель app/models/smile.rb
- ✅ Добавлена валидация поля `order_products_base_id`
- ✅ Добавлены методы `order_product` и `selected_product_title` для работы с выбранным товаром

## Как тестировать

### Подготовка к тестированию

1. Убедитесь, что в базе данных есть:
   - Заказы с номерами (`orders` с `eight_digit_id`)
   - Товары в заказах (`order_products` с `base_id`)
   - Таблица `smiles` с полем `order_products_base_id`

### Сценарии тестирования

#### Тест 1: Создание нового отзыва с выбором товара

1. **Перейдите** на страницу создания отзыва: `/admin/smiles/new`
2. **Заполните** обязательные поля:
   - Title (заголовок)
   - Body (текст отзыва)
3. **Введите номер заказа** в поле "Номер заказа" (8-значный номер)
4. **Кликните** в другое поле или нажмите Tab
5. **Проверьте**:
   - Появился блок с информацией о клиенте
   - Отобразился список товаров с радиокнопками
   - Первый товар выбран автоматически
   - В консоли браузера есть сообщения о выборе товара
6. **Выберите** другой товар кликом по радиокнопке
7. **Проверьте** в консоли, что base_id обновился
8. **Сохраните** отзыв
9. **Проверьте** в базе данных, что запись сохранилась с правильным `order_products_base_id`

#### Тест 2: Редактирование существующего отзыва

1. **Перейдите** на страницу редактирования отзыва: `/admin/smiles/edit/[ID]`
2. **Введите номер заказа** (если не был указан ранее)
3. **Выберите товар** из списка
4. **Сохраните изменения**
5. **Проверьте**, что `order_products_base_id` обновился в базе данных

#### Тест 3: Обработка ошибок

1. **Введите несуществующий номер заказа**
2. **Проверьте**, что отображается сообщение об ошибке
3. **Введите номер заказа без товаров**
4. **Проверьте**, что отображается соответствующее сообщение

#### Тест 4: Очистка данных

1. **Введите номер заказа** и дождитесь загрузки товаров
2. **Очистите поле номера заказа**
3. **Уберите фокус**
4. **Проверьте**, что блок с товарами исчез
5. **Проверьте в консоли**, что скрытое поле очищено

## Проверка логов

### Консоль браузера
При работе с функцией в консоли должны появляться сообщения:
```javascript
'Запрашиваем товары для заказа: [номер_заказа]'
'Ответ сервера: [данные_ответа]'
'Выбран товар: {base_id: XX, product_id: YY, ...}'
'Сохранён base_id в скрытое поле: XX'
'Автоматически выбран первый товар с base_id: XX'
'Очищено скрытое поле order_products_base_id'
```

### Серверные логи
Проверьте логи Padrino на предмет:
- Успешных запросов к `/admin/smiles/order_products/:order_id`
- Корректного сохранения параметров при создании/обновлении отзывов
- Отсутствия ошибок валидации

## Проверка базы данных

### SQL запросы для проверки

```sql
-- Проверить отзывы с привязкой к заказам
SELECT id, title, order_eight_digit_id, order_products_base_id 
FROM smiles 
WHERE order_eight_digit_id IS NOT NULL;

-- Проверить связь отзыв -> товар заказа
SELECT s.id, s.title, s.order_eight_digit_id, s.order_products_base_id, 
       op.product_id, op.title as product_title, op.base_id
FROM smiles s
JOIN order_products op ON s.order_products_base_id = op.base_id
WHERE s.order_products_base_id IS NOT NULL;
```

## Ожидаемое поведение

### ✅ Правильная работа
- Номер заказа распознается корректно
- Товары загружаются и отображаются с правильной информацией
- Выбор товара работает как клик по радиокнопке, так и клик по всему блоку
- Первый товар выбирается автоматически
- При сохранении `order_products_base_id` корректно записывается в базу
- Скрытое поле очищается при удалении номера заказа

### ❌ Неправильная работа
- Товары не загружаются при правильном номере заказа
- Выбор товара не влияет на скрытое поле
- При сохранении `order_products_base_id` остается пустым
- Ошибки JavaScript в консоли
- Некорректные данные в базе

## Дополнительные проверки

1. **Совместимость** с существующим функционалом выбора товаров через Vue.js компонент
2. **Производительность** при загрузке больших списков товаров
3. **Валидация** некорректных значений `base_id`
4. **Безопасность** - проверка доступа к API эндпоинту

---

**Дата создания:** 19.10.2025  
**Версия:** 1.0  
**Ответственный:** AI Assistant  
