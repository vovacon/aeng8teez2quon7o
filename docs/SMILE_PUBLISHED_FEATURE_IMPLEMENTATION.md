# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–º–∞–π–ª–æ–≤

## ‚úÖ –ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê

–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π ¬´—É–ª—ã–±–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π¬ª (—Å–º–∞–π–ª–æ–≤), –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

## üéØ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω—ã)

1. ‚úÖ **–¢—É–º–±–ª–µ—Ä "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ"** –≤ –∞–¥–º–∏–Ω–∫–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö `/admin/smiles/new` –∏ `/admin/smiles/edit/<id>`
2. ‚úÖ **–†–∞–±–æ—Ç–∞ —Å –ø–æ–ª–µ–º `published` —Ñ–æ—Ä–º–∞—Ç–∞ bit(1)** –≤ —Ç–∞–±–ª–∏—Ü–µ `smiles`
3. ‚úÖ **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π** –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö `/smiles`
4. ‚úÖ **–í—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º** –≤ –∞–¥–º–∏–Ω-—Å–ø–∏—Å–∫–µ `/admin/smiles`
5. ‚úÖ **–í–∫–ª–∞–¥–∫–∞ "–ù–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ"** –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
6. ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö –∂–µ helpers –∏ –º–µ—Ç–æ–¥–æ–≤**, —á—Ç–æ –∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ú–æ–¥–µ–ª—å Smile (`app/models/smile.rb`)

```ruby
# Scopes –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å BIT –ø–æ–ª–µ–º published
scope :published, -> { where(published: 1) }
scope :unpublished, -> { where(published: 0) }

# Helper –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
def published?
  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π helper –∏–∑ common.rb
  bit_field_to_bool(published)
end
```

### 2. –§–æ—Ä–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (`admin/views/smiles/_form.haml`)

```haml
- error = @smile.errors.include?(:published)
%fieldset.control-group{:class => error ? 'has-error' : ''}
  =f.label "–°—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏", :class => 'control-label'
  .controls
    =f.check_box :published, :checked => bit_field_to_bool(@smile.published)
    -# Debug: value=#{@smile.published.inspect}, type=#{@smile.published.class.to_s}, bit_result=#{bit_field_to_bool(@smile.published).to_s}
    %span.help-inline=error ? f.error_message_on(:published, :class => 'text-error') : '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ'
```

### 3. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (`admin/controllers/smiles.rb`)

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ published –≤ create/update:

```ruby
# –†–∞–∑—Ä–µ—à–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä published
allowed_params = smile_params.select { |k, v| 
  ['title', 'slug', 'body', 'images', 'rating', 'alt', 'smile_text', 'sidebar', 'order_eight_digit_id', 'order_products_base_id', 'seo_attributes', 'published'].include?(k) 
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ BIT –ø–æ–ª—è published –¥–ª—è MySQL
published_value = smile_params.has_key?('published') ? smile_params['published'] : '0'
published_int = (published_value == '1' || published_value == 1) ? 1 : 0
allowed_params['published'] = published_int

# –î–ª—è BIT –ø–æ–ª—è –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å
if allowed_params.has_key?('published')
  sql = "UPDATE smiles SET published = #{published_int} WHERE id = #{@smile.id}"
  ActiveRecord::Base.connection.execute(sql)
end
```

#### –ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö:

```ruby
# –ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –¥–ª—è –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å–º–∞–π–ª–æ–≤
get :unpublished do
  @title = "Unpublished Smiles"
  @smile = Smile.where(published: 0).order('created_at DESC').paginate(:page => params[:page], :per_page => 20)
  @filter_type = 'unpublished'
  render 'smiles/index'
end
```

### 4. –ê–¥–º–∏–Ω-—Å–ø–∏—Å–æ–∫ (`admin/views/smiles/index.haml`)

#### –í–∫–ª–∞–¥–∫–∏:

```haml
%ul.nav.nav-tabs
  %li{class: @filter_type == 'all' ? 'active' : ''}=link_to tag_icon(:list, pat(:list)), url(:smiles, :index)
  %li{class: @filter_type == 'unpublished' ? 'active' : ''}=link_to tag_icon(:'exclamation-sign', '–ù–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ'), url(:smiles, :unpublished)
  %li=link_to tag_icon(:plus, pat(:new)), url(:smiles, :new)
```

#### –õ–æ–≥–∏–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º:

```haml
-@smile.each do |smile|
  - published_value = smile.published
  - is_published = case published_value
  -   when 1, true, "1" then true
  -   when "\x01", "\001" then true  # BIT(1) = 1 in binary
  -   when 0, false, "0" then false
  -   when "\x00", "\000" then false  # BIT(1) = 0 in binary
  -   else published_value.to_i == 1
  - show_as_bold = !is_published && @filter_type != 'unpublished'
  - row_class = (!is_published && @filter_type != 'unpublished') ? 'list-row unpublished-smile' : 'list-row'
  %tr{class: row_class}
    %td.list-column
      - if show_as_bold
        %strong= smile.title
      - else
        = smile.title
```

#### CSS —Å—Ç–∏–ª–∏:

```css
.unpublished-smile {
  background-color: #fffbea !important;
}
```

### 5. –ü—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä (`app/controllers/smiles.rb`)

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:

```ruby
# –î–æ:
@posts = Smile.order('created_at DESC').limit(12)
@postsss = Smile.all

# –ü–æ—Å–ª–µ:
@posts = Smile.published.order('created_at DESC').limit(12)
@postsss = Smile.published
```

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–º–∞–π–ª–∞** –≤ `/admin/smiles/new`:
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç—É–º–±–ª–µ—Ä "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ" –Ω–µ –æ—Ç–º–µ—á–µ–Ω (published = 0)
   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å —Ç—É–º–±–ª–µ—Ä –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   
2. **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–∞–π–ª–∞** –≤ `/admin/smiles/edit/<id>`:
   - –¢—É–º–±–ª–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   - –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   
3. **–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤ –∞–¥–º–∏–Ω–∫–µ** `/admin/smiles`:
   - **–í–∫–ª–∞–¥–∫–∞ "–í—Å–µ"**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏, –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–¥–µ–ª–µ–Ω—ã –∂–∏—Ä–Ω—ã–º –∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã
   - **–í–∫–ª–∞–¥–∫–∞ "–ù–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ"**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ–±—ã—á–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
   
4. **–ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** `/smiles`:
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ** –∑–∞–ø–∏—Å–∏
   - –ù–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å–∫—Ä—ã—Ç—ã –æ—Ç –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π

## üõ°Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å MySQL BIT(1)

### –ü—Ä–æ–±–ª–µ–º–∞:
ActiveRecord –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–æ–ª—è–º–∏ BIT(1) –≤ MySQL.

### –†–µ—à–µ–Ω–∏–µ:
1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ helper `bit_field_to_bool()`** –∏–∑ `app/helpers/common.rb`
2. **–ü—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã** –¥–ª—è UPDATE –æ–ø–µ—Ä–∞—Ü–∏–π
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π** BIT –¥–∞–Ω–Ω—ã—Ö:
   - –°—Ç—Ä–æ–∫–∏: `"1"`, `"0"`, `"\x01"`, `"\x00"`
   - –ß–∏—Å–ª–∞: `1`, `0`
   - –ë—É–ª–µ–≤—ã: `true`, `false`
   - –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: `value.bytes.first == 1`

## üìä –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
- ‚úÖ `app/models/smile.rb` - –¥–æ–±–∞–≤–ª–µ–Ω—ã scopes –∏ –º–µ—Ç–æ–¥ published?
- ‚úÖ `admin/views/smiles/_form.haml` - –¥–æ–±–∞–≤–ª–µ–Ω —Ç—É–º–±–ª–µ—Ä published
- ‚úÖ `admin/controllers/smiles.rb` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ published –≤ create/update + –º–∞—Ä—à—Ä—É—Ç unpublished
- ‚úÖ `admin/views/smiles/index.haml` - –≤–∫–ª–∞–¥–∫–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö
- ‚úÖ `app/controllers/smiles.rb` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ helpers:
- ‚úÖ `bit_field_to_bool()` –∏–∑ `app/helpers/common.rb` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ BIT –ø–æ–ª–µ–π
- ‚úÖ Scopes `published` –∏ `unpublished` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ú–µ—Ç–æ–¥ `published?` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç: `test_smile_published_functionality.rb`

```bash
./test_smile_published_functionality.rb
```

### –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:
- ‚úÖ –ù–∞–ª–∏—á–∏–µ scopes –≤ –º–æ–¥–µ–ª–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ BIT –ø–æ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ö
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –≤–∫–ª–∞–¥–∫–∏ "–ù–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ"
- ‚úÖ –õ–æ–≥–∏–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
- ‚úÖ CSS —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

**‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –∏–¥–µ–Ω—Ç–∏—á–µ–Ω —Ä–∞–±–æ—Ç–µ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏**:

1. **–ê–¥–º–∏–Ω–∫–∞**: —Ç—É–º–±–ª–µ—Ä "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ" –≤ —Ñ–æ—Ä–º–∞—Ö create/edit
2. **–ê–¥–º–∏–Ω-—Å–ø–∏—Å–æ–∫**: –≤–∫–ª–∞–¥–∫–∞ "–ù–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ" + –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
3. **–ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã**: –ø–æ–∫–∞–∑ —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å MySQL BIT(1) –ø–æ–ª–µ–º —á–µ—Ä–µ–∑ helpers
5. **–ê–Ω–∞–ª–æ–≥–∏—è —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç–µ –∂–µ –ø–æ–¥—Ö–æ–¥—ã –∏ –º–µ—Ç–æ–¥—ã

---

*–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: 24 –æ–∫—Ç—è–±—Ä—è 2025*  
*–°—Ç–∞—Ç—É—Å: ‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é*  
*–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ*
