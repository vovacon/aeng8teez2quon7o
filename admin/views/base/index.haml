- # encoding: utf-8
.base-text
  %p Добро пожаловать в панель администрирования сайта самого лучшего в мире магазина цветов «Розарио»!
  
  -if current_account
    %p
      %strong Пользователь: 
      - begin
        = current_account.display_name
      - rescue => e
        = current_account.email || "Пользователь #{current_account.id}"
      - begin
        %span.label{:class => role_class(current_account.role)}
          =current_account.role
      - rescue => e
        %span.label.label-default
          = current_account.role || 'unknown'
        
    - begin
      - permissions_check = can_manage_permissions?
      .alert.alert-success{style: "margin: 10px 0;"}
        %strong Debug:
        current_account: #{current_account&.id}, role: #{current_account&.role}, can_manage: #{permissions_check}
      -if permissions_check
        .alert.alert-info{id: "permissions-block", style: "margin: 10px 0;"}
          %strong Управление правами:
          =link_to "Настроить права доступа", url(:permissions, :index), :class => "btn btn-info btn-small", :style => "margin-left: 10px;"
      - else
        .alert.alert-warning{style: "margin: 10px 0;"}
          %strong Info:
          Нет прав на управление правами (нужна роль admin)
    - rescue => e
      .alert.alert-danger{style: "margin: 10px 0;"}
        %strong Exception:
        = e.message
        %br
        = e.backtrace&.first
        
    %h3 Доступные разделы:
    .available-modules
      -if @available_modules && @available_modules.any?
        .row
          -@available_modules.each_with_index do |mod, index|
            -if index % 4 == 0
              .row
            .span3
              =link_to "/admin/#{mod}", :class => "module-card-link" do
                .module-card
                  %h4=humanize_module_name(mod)
                  .module-icon
                    - icon_path = "app/views/icons/#{mod}.svg"
                    - if File.exist?(icon_path)
                      = File.read(icon_path).html_safe
                    - else
                      %p.module-code=mod
      -else
        .alert.alert-warning У вас нет доступа ни к одному разделу. Обратитесь к администратору.

.base-icons
  .btn-group
    .btn.btn-primary{:title => ""}=tag_icon("icon-2x", "")
    .btn.btn-success{:title => ""}=tag_icon("icon-2x", "")
    .btn.btn-info{:title => ""}=tag_icon("icon-2x", "")
    .btn.btn-warning{:title => ""}=tag_icon("icon-2x", "")
    .btn.btn-danger{:title => ""}=tag_icon("icon-2x", "")

.base-text
  - project_modules.each do |project_module|
    %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
      =link_to I18n.t("padrino.admin.menu.#{project_module.name}"), project_module.path('/admin')
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Слайдшоу", url(:slideshows, :index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Слайды", url(:slides, :index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Заказы", url(:orders,:index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Рассылка", url(:mailing, :index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Теги", url(:tags, :index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Витрина", "/admin/categories/showcase"
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Улыбки", url(:smiles, :index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    %a{ href: "/category/oldbukets" } Старая версия букетов
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Календарь (заказы)", url(:disabled_dates, :index)
  %h2{:style => "display:inline;margin-right:12px;line-height:1.65;margin-right:30px;"}
    =link_to "Способы оплаты", url(:payment_methods, :index)

:css
  .module-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }
  .module-card-link:hover {
    text-decoration: none;
    color: inherit;
  }
  .module-card {
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
    background: #f9f9f9;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  .module-card:hover {
    background: #e9e9e9;
    border-color: #bbb;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .module-card h4 {
    margin: 0 0 10px 0;
    color: #333;
    transition: color 0.2s ease;
  }
  .module-card:hover h4 {
    color: #000;
  }
  .available-modules .row {
    margin-bottom: 10px;
  }
  .module-icon {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 10px 0;
  }
  .module-icon svg {
    width: 48px;
    height: 48px;
    stroke: #000000;
    transition: all 0.2s ease;
  }
  .module-card:hover .module-icon svg {
    stroke: #0066cc;
    transform: scale(1.1);
  }
  .module-code {
    color: #999;
    font-size: 12px;
    margin: 5px 0;
  }
  
  /* Debug styles */
  .alert {
    opacity: 1 !important;
    visibility: visible !important;
    display: block !important;
  }

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin page loaded');
    
    var permissionsBlock = document.getElementById('permissions-block');
    if (permissionsBlock) {
      console.log('Permissions block found:', permissionsBlock);
      
      // Следим за изменениями
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes') {
            console.log('Permissions block attribute changed:', mutation.attributeName, permissionsBlock.style.display);
          }
          if (mutation.type === 'childList') {
            console.log('Permissions block children changed');
          }
        });
      });
      
      observer.observe(permissionsBlock, {
        attributes: true,
        childList: true,
        subtree: true
      });
      
      // Проверяем каждую секунду
      var checkInterval = setInterval(function() {
        if (!document.getElementById('permissions-block')) {
          console.log('Permissions block disappeared!');
          clearInterval(checkInterval);
        } else {
          console.log('Permissions block still visible');
        }
      }, 1000);
      
      // Останавливаем проверку через 10 секунд
      setTimeout(function() {
        clearInterval(checkInterval);
        console.log('Stopped monitoring permissions block');
      }, 10000);
    } else {
      console.log('Permissions block NOT found');
    }
    
    // Проверяем все alert блоки
    var alerts = document.querySelectorAll('.alert');
    console.log('Found alerts:', alerts.length);
    alerts.forEach(function(alert, index) {
      console.log('Alert', index, ':', alert.className, alert.textContent.substring(0, 50));
    });
  });
