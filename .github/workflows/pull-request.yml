name: üîç Pull Request –ü—Ä–æ–≤–µ—Ä–∫–∏

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  RUBY_VERSION: '2.7'

jobs:
  pr-validation:
    name: üîç –í–∞–ª–∏–¥–∞—Ü–∏—è PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        
    - name: üìà –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      run: |
        echo "üìà –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ PR..."
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
        
        echo "### üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        echo "$CHANGED_FILES"
        echo ""
        
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
        RUBY_FILES=$(echo "$CHANGED_FILES" | grep -E '\.rb$' | wc -l)
        HAML_FILES=$(echo "$CHANGED_FILES" | grep -E '\.haml$' | wc -l)
        CONFIG_FILES=$(echo "$CHANGED_FILES" | grep -E '^config/' | wc -l)
        TEST_FILES=$(echo "$CHANGED_FILES" | grep -E '^tests/' | wc -l)
        GEMFILE_CHANGED=$(echo "$CHANGED_FILES" | grep -E '^Gemfile' | wc -l)
        
        echo "### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:"
        echo "Ruby —Ñ–∞–π–ª–æ–≤: $RUBY_FILES"
        echo "HAML —à–∞–±–ª–æ–Ω–æ–≤: $HAML_FILES"
        echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: $CONFIG_FILES"
        echo "–¢–µ—Å—Ç—ã: $TEST_FILES"
        
        if [ "$GEMFILE_CHANGED" -gt 0 ]; then
          echo "‚ö†Ô∏è  Gemfile –±—ã–ª –∏–∑–º–µ–Ω—ë–Ω - –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –æ—Å–æ–±–æ–º –≤–Ω–∏–º–∞–Ω–∏–∏"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ PR
        TOTAL_CHANGED=$(echo "$CHANGED_FILES" | wc -l)
        if [ "$TOTAL_CHANGED" -gt 50 ]; then
          echo "üö® –û—á–µ–Ω—å –±–æ–ª—å—à–æ–π PR ($TOTAL_CHANGED —Ñ–∞–π–ª–æ–≤) - —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –º–µ–Ω—å—à–∏–µ PR"
        elif [ "$TOTAL_CHANGED" -gt 20 ]; then
          echo "‚ö†Ô∏è  –ë–æ–ª—å—à–æ–π PR ($TOTAL_CHANGED —Ñ–∞–π–ª–æ–≤) - –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–≤—å—é"
        else
          echo "‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä PR ($TOTAL_CHANGED —Ñ–∞–π–ª–æ–≤)"
        fi
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–º–º–∏—Ç–æ–≤..."
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤ –≤ PR
        COMMITS=$(git log --pretty=format:"%s" origin/${{ github.base_ref }}..HEAD)
        
        echo "### üìù –ö–æ–º–º–∏—Ç—ã –≤ PR:"
        echo "$COMMITS"
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        BAD_COMMITS=0
        
        while IFS= read -r commit_msg; do
          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
          [ -z "$commit_msg" ] && continue
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–ª–æ—Ö–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫
          if echo "$commit_msg" | grep -qi "^fix\|^wip\|^temp\|^test"; then
            echo "‚ö†Ô∏è  –ù–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: $commit_msg"
            ((BAD_COMMITS++))
          elif [ ${#commit_msg} -lt 10 ]; then
            echo "‚ö†Ô∏è  –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: $commit_msg"
            ((BAD_COMMITS++))
          fi
        done <<< "$COMMITS"
        
        if [ $BAD_COMMITS -eq 0 ]; then
          echo "‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤ –≤—ã–≥–ª—è–¥—è—Ç —Ö–æ—Ä–æ—à–æ"
        else
          echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–æ $BAD_COMMITS –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–º–º–∏—Ç–æ–≤"
        fi
        
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: false
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö Ruby —Ñ–∞–π–ª–æ–≤..."
        
        CHANGED_RUBY_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep '\.rb$' || true)
        
        if [ -z "$CHANGED_RUBY_FILES" ]; then
          echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö Ruby —Ñ–∞–π–ª–æ–≤"
          exit 0
        fi
        
        ERROR_COUNT=0
        
        for file in $CHANGED_RUBY_FILES; do
          if [ -f "$file" ]; then
            echo "  ‚úì –ü—Ä–æ–≤–µ—Ä—è–µ–º: $file"
            if ! ruby -c "$file" > /dev/null 2>&1; then
              echo "    ‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ $file"
              ruby -c "$file"
              ((ERROR_COUNT++))
            fi
          fi
        done
        
        if [ $ERROR_COUNT -gt 0 ]; then
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ $ERROR_COUNT –æ—à–∏–±–æ–∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
          exit 1
        else
          echo "‚úÖ –í—Å–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ Ruby —Ñ–∞–π–ª—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
        fi
        
    - name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ PR..."
        gem install minitest json --no-document
        cd tests
        chmod +x run_unit_tests.sh
        ./run_unit_tests.sh
        
    - name: üìà –û—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö
      if: always()
      run: |
        echo "üìà –û—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö PR:"
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Ruby"
        echo "‚úÖ Unit —Ç–µ—Å—Ç—ã (91 —Ç–µ—Å—Ç –≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ)"
        echo "‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–º–º–∏—Ç–æ–≤"
        echo ""
        echo "üìù –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: make test-unit"
        echo "üìÑ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
