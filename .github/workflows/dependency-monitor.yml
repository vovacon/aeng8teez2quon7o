name: üîí –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    paths:
      - 'Gemfile*'
      - '.github/workflows/dependency-monitor.yml'

jobs:
  dependency-audit:
    name: üîç –ê—É–¥–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    runs-on: ubuntu-latest
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
        bundler-cache: false
        
    - name: üõ†Ô∏è –ê–Ω–∞–ª–∏–∑ Gemfile
      run: |
        echo "üõ†Ô∏è  –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞..."
        
        echo "### üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
        TOTAL_GEMS=$(grep -c "^gem " Gemfile || echo "0")
        GROUP_GEMS=$(grep -c "^gem .* group:" Gemfile || echo "0")
        LOCAL_GEMS=$(grep -c "path:" Gemfile || echo "0")
        
        echo "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ gem'–æ–≤: $TOTAL_GEMS"
        echo "Gem'—ã –≤ –≥—Ä—É–ø–ø–∞—Ö: $GROUP_GEMS"
        echo "–õ–æ–∫–∞–ª—å–Ω—ã–µ gem'—ã: $LOCAL_GEMS"
        
        echo "\n### üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:"
        
        # –ö—Ä–∏—Ç–∏—á–Ω—ã–µ gem'—ã –¥–ª—è Ruby/Padrino –ø—Ä–æ–µ–∫—Ç–∞
        CRITICAL_GEMS=(
          "padrino:Padrino Framework"
          "sinatra:Sinatra Web Framework"
          "activerecord:ActiveRecord ORM"
          "mysql2:MySQL Database Adapter"
          "redis:Redis Client"
          "sidekiq:Background Jobs"
          "haml:HAML Templates"
        )
        
        MISSING_CRITICAL=0
        
        for gem_info in "${CRITICAL_GEMS[@]}"; do
          gem_name=$(echo $gem_info | cut -d: -f1)
          gem_desc=$(echo $gem_info | cut -d: -f2)
          
          if grep -q "gem ['\"]$gem_name['\"]" Gemfile; then
            VERSION=$(grep "gem ['\"]$gem_name['\"]" Gemfile | head -1)
            echo "‚úÖ $gem_desc: $VERSION"
          else
            echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $gem_desc ($gem_name)"
            ((MISSING_CRITICAL++))
          fi
        done
        
        if [ $MISSING_CRITICAL -gt 0 ]; then
          echo "‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç $MISSING_CRITICAL –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        fi
        
    - name: üïµÔ∏è‚Äç‚ôÇÔ∏è –ü–æ–∏—Å–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π
      run: |
        echo "üïµÔ∏è‚Äç‚ôÇÔ∏è –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—ã—Ö/–æ–ø–∞—Å–Ω—ã—Ö –≤–µ—Ä—Å–∏–π
        OUTDATED_PATTERNS=(
          "padrino.*0\.[0-9]\."
          "sinatra.*1\.[0-3]\."
          "activerecord.*[2-3]\."
          "rails.*[0-4]\."
          "nokogiri.*1\.[0-8]\."
          "rack.*1\."
        )
        
        OUTDATED_FOUND=false
        
        echo "### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
        
        for pattern in "${OUTDATED_PATTERNS[@]}"; do
          if grep -E "$pattern" Gemfile.lock 2>/dev/null; then
            echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤–µ—Ä—Å–∏—è, —Ç—Ä–µ–±—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $pattern"
            OUTDATED_FOUND=true
          fi
        done
        
        if [ "$OUTDATED_FOUND" = "false" ]; then
          echo "‚úÖ –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—á–µ–≤–∏–¥–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π"
        fi
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        echo "üîç –ê–Ω–∞–ª–∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        
        LOCAL_GEMS=$(grep "path:" Gemfile || true)
        
        if [ -n "$LOCAL_GEMS" ]; then
          echo "### üìç –õ–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
          echo "$LOCAL_GEMS"
          
          echo "\n‚ö†Ô∏è  **–í–Ω–∏–º–∞–Ω–∏–µ**: –õ–æ–∫–∞–ª—å–Ω—ã–µ gem'—ã –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:"
          echo "- –ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –¥—Ä—É–≥–∏—Ö –º–∞—à–∏–Ω–∞—Ö"
          echo "- –ú–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å CI/CD"
          echo "- –£—Å–ª–æ–∂–Ω—è—é—Ç —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ"
          
          echo "\nüõ†Ô∏è  **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:"
          echo "- –û–ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ gem'—ã –Ω–∞ RubyGems.org"
          echo "- –õ–∏–±–æ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π gem —Å–µ—Ä–≤–µ—Ä"
          echo "- –õ–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
        else
          echo "‚úÖ –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        fi
        
    - name: üìà –û—Ç—á—ë—Ç –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
      run: |
        echo "### üìà –û—Ç—á—ë—Ç –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö Rozario Flowers"
        echo "–î–∞—Ç–∞: $(date)"
        echo "Commit: ${{ github.sha }}"
        
        if [ -f "Gemfile.lock" ]; then
          echo "\n**–¢–æ–ø-10 –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É:**"
          grep "^ " Gemfile.lock | grep -E "^[[:space:]]+[a-z]" | head -10 | sed 's/^[[:space:]]*/- /' || true
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Ruby –≤–µ—Ä—Å–∏–∏
        if grep -q "ruby " Gemfile; then
          RUBY_VERSION=$(grep "ruby " Gemfile | head -1)
          echo "\n**Ruby –≤–µ—Ä—Å–∏—è:** $RUBY_VERSION"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à—É—é Ruby
          if echo "$RUBY_VERSION" | grep -E "ruby ['\"]?[01]\.|ruby ['\"]?2\.[0-6]"; then
            echo "‚ö†Ô∏è  **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è Ruby"
          fi
        fi
        
        echo "\n‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
