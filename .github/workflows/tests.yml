name: üß™ –¢–µ—Å—Ç—ã –∏ –ü—Ä–æ–≤–µ—Ä–∫–∏ Rozario Flowers

on:
  push:
    branches: [ main, develop, sketch-wip ]
    paths:
      - 'app/**'
      - 'admin/**'
      - 'tests/**'
      - 'config/**'
      - 'lib/**'
      - 'Gemfile*'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'app/**'
      - 'admin/**' 
      - 'tests/**'
      - 'config/**'
      - 'lib/**'
      - 'Gemfile*'
  schedule:
    # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    inputs:
      test_type:
        description: '–¢–∏–ø —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - security
        - unit
        - performance

env:
  RUBY_VERSION: '2.7'
  
jobs:
  security-scan:
    name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üîç –ü–æ–∏—Å–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
      run: |
        echo "üîç –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤..."
        
        # –ü–æ–∏—Å–∫ API –∫–ª—é—á–µ–π, –ø–∞—Ä–æ–ª–µ–π, —Ç–æ–∫–µ–Ω–æ–≤
        SECRETS_FOUND=false
        
        if grep -r -i --include="*.rb" --include="*.yml" --include="*.yaml" --include="*.env" \
           --exclude-dir="+" --exclude-dir="./+" \
           -E '(password|secret|key|token)\s*[=:]\s*["\047][^"\047]{8,}["\047]' . | \
           grep -v -E '(test|spec|example|placeholder|your_|xxx|yyy|zzz)'; then
          echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã!"
          SECRETS_FOUND=true
        fi
        
        # –ü–æ–∏—Å–∫ IP –∞–¥—Ä–µ—Å–æ–≤ (–∫—Ä–æ–º–µ localhost)
        if grep -r --include="*.rb" --include="*.yml" \
           --exclude-dir="+" --exclude-dir="./+" \
           -E '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' . | \
           grep -v -E '(127\.0\.0\.1|0\.0\.0\.0|localhost)'; then
          echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞!"
          SECRETS_FOUND=true
        fi
        
        if [ "$SECRETS_FOUND" = "true" ]; then
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
          exit 1
        else
          echo "‚úÖ –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞"
        fi
        
    - name: üîç –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      run: |
        echo "üîç –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è..."
        echo "‚ÑπÔ∏è  –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º workflow"
        echo "‚ÑπÔ∏è  –°–º. '.github/workflows/security-advanced.yml' –¥–ª—è GitLeaks, Semgrep, Trivy"

  code-quality:
    name: üìù –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: false
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Ruby
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Ruby —Ñ–∞–π–ª–æ–≤..."
        ERROR_COUNT=0
        
        find . -name "*.rb" -not -path "./tests/archive/*" | while IFS= read -r file; do
          echo "  ‚úì –ü—Ä–æ–≤–µ—Ä—è–µ–º: $file"
          if ! ruby -c "$file" > /dev/null 2>&1; then
            echo "    ‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ $file"
            ruby -c "$file"
            ((ERROR_COUNT++))
          fi
        done
        
        if [ $ERROR_COUNT -gt 0 ]; then
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ $ERROR_COUNT –æ—à–∏–±–æ–∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
          exit 1
        else
          echo "‚úÖ –í—Å–µ Ruby —Ñ–∞–π–ª—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã"
        fi
    
    - name: üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ HAML —à–∞–±–ª–æ–Ω–æ–≤
      run: |
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ HAML —à–∞–±–ª–æ–Ω–æ–≤..."
        
        HAML_COUNT=$(find . -name "*.haml" -not -path "./+/*" | wc -l)
        ERB_COUNT=$(find . -name "*.erb" -not -path "./+/*" | wc -l)
        
        echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤:"
        echo "  - HAML: $HAML_COUNT —Ñ–∞–π–ª–æ–≤"
        echo "  - ERB: $ERB_COUNT —Ñ–∞–π–ª–æ–≤"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
        CRITICAL_TEMPLATES=(
          "app/views/layouts/application.haml"
          "app/views/index.haml" 
          "admin/views/layouts/application.haml"
        )
        
        for template in "${CRITICAL_TEMPLATES[@]}"; do
          if [ -f "$template" ]; then
            echo "‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–∞–π–¥–µ–Ω: $template"
          else
            echo "‚ö†Ô∏è  –ö—Ä–∏—Ç–∏—á–Ω—ã–π —à–∞–±–ª–æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: $template"
          fi
        done
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        REQUIRED_FILES=(
          "config/boot.rb"
          "config/database.rb"
          "config/apps.rb"
          "app/app.rb"
          "admin/app.rb"
          "Gemfile"
          "config.ru"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª: $file"
          else
            echo "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª: $file"
            exit 1
          fi
        done
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Gemfile
        if grep -q "gem 'padrino'" Gemfile; then
          echo "‚úÖ Padrino framework –¥–æ–±–∞–≤–ª–µ–Ω –≤ Gemfile"
        else
          echo "‚ùå Padrino framework –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Gemfile"
          exit 1
        fi

  dependencies-check:
    name: üõ†Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: false
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Gemfile
      run: |
        echo "üîç –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –≥–µ–º—ã
        CRITICAL_GEMS=("padrino" "activerecord" "mysql2" "haml" "redis")
        
        for gem in "${CRITICAL_GEMS[@]}"; do
          if grep -q "gem ['\"]$gem['\"]" Gemfile; then
            echo "‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–π gem: $gem"
          else
            echo "‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã–π gem: $gem"
          fi
        done
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –≥–µ–º—ã
        if grep -q "path:" Gemfile; then
          echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –≥–µ–º—ã:"
          grep "path:" Gemfile
          echo "üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–∫–∏–µ –≥–µ–º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ç–µ—Å—Ç–∞—Ö"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π
        echo "üìä –í–µ—Ä—Å–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –≥–µ–º–æ–≤:"
        grep -E "gem ['\"]*(padrino|activerecord|sinatra|ruby)['\"]" Gemfile || true
        
    - name: üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –≥–µ–º–æ–≤
        VULNERABLE_PATTERNS=(
          "sinatra.*1\.[0-3]\." # Old Sinatra versions
          "rails.*[0-4]\."
          "nokogiri.*1\.[0-9]\."
        )
        
        VULNERABILITIES_FOUND=false
        
        for pattern in "${VULNERABLE_PATTERNS[@]}"; do
          if grep -E "$pattern" Gemfile.lock 2>/dev/null; then
            echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —É—è–∑–≤–∏–º–∞—è –≤–µ—Ä—Å–∏—è: $pattern"
            VULNERABILITIES_FOUND=true
          fi
        done
        
        if [ "$VULNERABILITIES_FOUND" = "false" ]; then
          echo "‚úÖ –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—á–µ–≤–∏–¥–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π"
        fi

  unit-tests:
    name: üß™ Unit –¢–µ—Å—Ç—ã
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality] # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫–∞—á–µ—Å—Ç–≤–∞
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: false
        
    - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        gem install minitest json --no-document
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ CI —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      run: |
        cd tests
        ruby check_ci_compatibility.rb
        
    - name: üß™ –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç–æ–≤
      run: |
        cd tests
        chmod +x run_unit_tests.sh
        ./run_unit_tests.sh
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ Smile
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å SQL-–∑–∞–ø—Ä–æ—Å–æ–≤..."
        ruby test_smile_fix_verification.rb
        
    - name: ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ Smile
      run: |
        echo "‚öôÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤..."
        ruby test_smile_logic.rb
        ruby spec/admin_date_helpers_spec.rb
        
    - name: üõçÔ∏è –¢–µ—Å—Ç—ã order_products —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      run: |
        echo "üõçÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è order_products (id->order_id)..."
        cd tests
        ruby unit/order_products_structure_test.rb
        ruby integration/test_order_products_flow.rb
        ruby utils/order_products_performance_analysis.rb
        
    - name: üìß –¢–µ—Å—Ç—ã Email —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
      run: |
        echo "üìß –¢–µ—Å—Ç–∏—Ä—É–µ–º email –æ—Ç–ø—Ä–∞–≤–∫—É –∏ smart encoding..."
        cd tests
        ruby unit/smart_encoding_test.rb
        ruby unit/email_functionality_test.rb
        ruby integration/test_email_order_integration.rb
        
    - name: üîÑ –¢–µ—Å—Ç—ã 1C Exchange API —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      run: |
        echo "üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 1C Exchange API —Å order_products..."
        cd tests
        # –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–±–µ–∑ nokogiri)
        ruby unit/order_products_1c_compatibility_test.rb
        ruby integration/test_1c_exchange_api.rb
        
    - name: üîÑ –¢–µ—Å—Ç—ã 1C Notify Update API
      run: |
        echo "üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–π 1C Notify Update API endpoint..."
        cd tests
        # –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è 1c_notify_update
        chmod +x run_1c_notify_update_tests.sh
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ unit –∏ mock —Ç–µ—Å—Ç—ã –≤ CI (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤)
        ./run_1c_notify_update_tests.sh --no-integration
        
    - name: üìà –û—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∞—Ö
      if: always()
      run: |
        echo "‚úÖ Unit —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
        echo "üìà –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:"
        echo "  - CI Integration: 10 —Ç–µ—Å—Ç–æ–≤, 23 assertions"
        echo "  - Schema Helper: 15 —Ç–µ—Å—Ç–æ–≤, 75 assertions"
        echo "  - FAQ Schema: 11 —Ç–µ—Å—Ç–æ–≤, 125 assertions"
        echo "  - Smile Products: 7 —Ç–µ—Å—Ç–æ–≤, 45 assertions"
        echo "  - Smile Multiple Comments: 12 —Ç–µ—Å—Ç–æ–≤, 65 assertions (–ù–û–í–´–ï)"
        echo "  - Smile Aggregated Schema: 10 —Ç–µ—Å—Ç–æ–≤, 55 assertions (–ù–û–í–´–ï)"
        echo "  - Smile Admin Functionality: 15 —Ç–µ—Å—Ç–æ–≤, 80 assertions (–ù–û–í–´–ï)"
        echo "  - CI Improvements: 11 —Ç–µ—Å—Ç–æ–≤, 45 assertions (–ù–û–í–´–ï)"
        echo "  - Order Products Structure: 9 —Ç–µ—Å—Ç–æ–≤, 27+ assertions (–ù–û–í–´–ï)"
        echo "  - Smart Encoding Detection: 8 —Ç–µ—Å—Ç–æ–≤, 40+ assertions (–ù–û–í–´–ï)"
        echo "  - Email Functionality: 12 —Ç–µ—Å—Ç–æ–≤, 60+ assertions (–ù–û–í–´–ï)"
        echo "  - Email Order Integration: 7 —Ç–µ—Å—Ç–æ–≤, 35+ assertions (–ù–û–í–´–ï)"
        echo "  - 1C Notify Update Validation: 25+ —Ç–µ—Å—Ç–æ–≤, 100+ assertions (–ù–û–í–´–ï)"
        echo "  - 1C Notify Update HTTP/Mocks: 15+ —Ç–µ—Å—Ç–æ–≤, 75+ assertions (–ù–û–í–´–ï)"
        echo "  - –ò—Ç–æ–≥–æ: 167+ —Ç–µ—Å—Ç–æ–≤, 850+ assertions"
        
    - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: tests/reports/
        retention-days: 30

  performance-check:
    name: üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üìà –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–¥–∞
      run: |
        echo "üìà –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
        
        echo "### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
        echo "Ruby —Ñ–∞–π–ª—ã:    $(find . -name '*.rb' -not -path './+/*' | wc -l)"
        echo "HAML —à–∞–±–ª–æ–Ω—ã:  $(find . -name '*.haml' -not -path './+/*' | wc -l)"
        echo "ERB —à–∞–±–ª–æ–Ω—ã:   $(find . -name '*.erb' -not -path './+/*' | wc -l)"
        echo "JavaScript:    $(find . -name '*.js' -not -path './+/*' | wc -l)"
        echo "CSS:           $(find . -name '*.css' -o -name '*.scss' -not -path './+/*' | wc -l)"
        
        echo "\n### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤:"
        echo "Unit —Ç–µ—Å—Ç—ã:      $(find tests/unit -name '*.rb' 2>/dev/null | wc -l)"
        echo "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:     $(find tests/integration -name '*.rb' 2>/dev/null | wc -l)"
        echo "UI —Ç–µ—Å—Ç—ã:        $(find tests/ui -name '*.html' 2>/dev/null | wc -l)"
        echo "–£—Ç–∏–ª–∏—Ç—ã:         $(find tests/utils -name '*.rb' 2>/dev/null | wc -l)"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤
        echo "\n### üîç –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:"
        LARGE_FILES=$(find . -name '*.rb' -not -path './tests/archive/*' -not -path './+/*' -exec wc -l {} + | awk '$1 > 500 {print $2 " (" $1 " —Å—Ç—Ä–æ–∫)"}' || true)
        
        if [ -n "$LARGE_FILES" ]; then
          echo "üîÑ –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (>500 —Å—Ç—Ä–æ–∫):"
          echo "$LARGE_FILES"
        else
          echo "‚úÖ –ù–µ—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ TODO/FIXME
        echo "\n### üìù TODO/FIXME –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:"
        TODO_COUNT=$(grep -r -i --include="*.rb" --include="*.haml" --exclude-dir="+" --exclude-dir="./+" "TODO\|FIXME\|HACK" . | wc -l || echo "0")
        echo "–ù–∞–π–¥–µ–Ω–æ: $TODO_COUNT –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"
        
        if [ "$TODO_COUNT" -gt 0 ]; then
          echo "–ü–µ—Ä–≤—ã–µ 5:"
          grep -r -i --include="*.rb" --include="*.haml" --exclude-dir="+" --exclude-dir="./+" "TODO\|FIXME\|HACK" . | head -5 || true
        fi

  accessibility-check:
    name: ‚ôø –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: ‚ôø –ü—Ä–æ–≤–µ—Ä–∫–∞ HTML –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
      run: |
        echo "‚ôø –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª accessibility..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ alt –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        MISSING_ALT=0
        
        # –ü–æ–∏—Å–∫ <img> –±–µ–∑ alt –≤ HAML
        if find . -name "*.haml" -not -path "./+/*" -exec grep -l "%img" {} \; | xargs grep "%img" | grep -v "alt" 2>/dev/null; then
          echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ alt –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ HAML"
          MISSING_ALT=1
        fi
        
        # –ü–æ–∏—Å–∫ <img> –±–µ–∑ alt –≤ ERB
        if find . -name "*.erb" -not -path "./+/*" -exec grep -l "<img" {} \; | xargs grep "<img" | grep -v "alt=" 2>/dev/null; then
          echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ alt –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ ERB"
          MISSING_ALT=1
        fi
        
        if [ $MISSING_ALT -eq 0 ]; then
          echo "‚úÖ –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ—é—Ç alt –∞—Ç—Ä–∏–±—É—Ç—ã"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ–≥–æ–≤
        echo "\n### üè∑Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∏:"
        
        SEMANTIC_TAGS=("header" "main" "footer" "nav" "article" "section")
        
        for tag in "${SEMANTIC_TAGS[@]}"; do
          if find . \( -name "*.haml" -o -name "*.erb" \) -not -path "./+/*" | xargs grep -l "$tag" 2>/dev/null; then
            echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–≥: <$tag>"
          fi
        done

  integration-tests:
    name: üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã 1C
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ 1C –∫–æ–¥–µ
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.modified, 'app/controllers/api.rb')
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: false
        
    - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        gem install minitest json net-http uri --no-document
        
    - name: üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã 1C Notify Update
      env:
        TEST_BASE_URL: "https://staging.rozarioflowers.ru"  # –ò–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
      run: |
        echo "üîó –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤..."
        cd tests
        chmod +x run_1c_notify_update_tests.sh
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
        ./run_1c_notify_update_tests.sh --integration-only
        
    - name: üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-logs
        path: |
          log/1c_notify_update_tests.log
          log/1c_notify_update_test_report.txt
          log/1c_notify_update.log
        retention-days: 7

  database-tests:
    name: üó∫Ô∏è –¢–µ—Å—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: admin_rozario_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3
      
    - name: üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
        bundler-cache: true
        
    - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î
      run: |
        mysql -h 127.0.0.1 -u root -ppassword -e "CREATE DATABASE admin_rozario_test;"
        
    - name: üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—Ö–µ–º—ã
      run: |
        mysql -h 127.0.0.1 -u root -ppassword admin_rozario_test << 'EOF'
        CREATE TABLE IF NOT EXISTS comments (
          id INT AUTO_INCREMENT PRIMARY KEY,
          name VARCHAR(255),
          body TEXT,
          rating FLOAT DEFAULT 5.0,
          published BIT(1) DEFAULT 1,
          order_eight_digit_id INT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS orders (
          id INT AUTO_INCREMENT PRIMARY KEY,
          eight_digit_id INT UNIQUE,
          email VARCHAR(255),
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS smiles (
          id INT AUTO_INCREMENT PRIMARY KEY,
          title VARCHAR(255),
          body TEXT,
          rating INT DEFAULT 5,
          published BIT(1) DEFAULT 1,
          order_eight_digit_id INT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        );
        
        -- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        INSERT INTO comments (name, body, rating, published) VALUES
        ('Test User 1', '–û—Ç–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å!', 5.0, 1),
        ('Test User 2', '–ù–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –ª—É—á—à–µ', 3.5, 0);
        
        INSERT INTO orders (eight_digit_id, email) VALUES
        (12345678, 'test@example.com'),
        (87654321, 'user@test.com');
        EOF
        
    - name: üß™ –ó–∞–ø—É—Å–∫ –ë–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ë–î
      env:
        DB_HOST: 127.0.0.1
        DB_NAME: admin_rozario_test
        DB_USER: root
        DB_PASSWORD: password
      run: |
        gem install activerecord mysql2 --no-document
        cd tests
        ruby integration/test_basic_models.rb

  lint-check:
    name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
    - name: üìã –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Ruby
      run: |
        find . -name "*.rb" -not -path "./tests/archive/*" | head -10 | while read file; do
          echo "‚úì –ü—Ä–æ–≤–µ—Ä—è–µ–º $file"
          ruby -c "$file" || exit 1
        done
        
    - name: üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ HAML —Ñ–∞–π–ª–æ–≤
      run: |
        echo "üìã HAML —Ñ–∞–π–ª–æ–≤: $(find . -name '*.haml' -not -path './+/*' | wc -l)"
        echo "‚úì –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –ø–æ—Ä—è–¥–∫–µ"


  summary:
    name: üìà –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, dependencies-check, unit-tests, performance-check, accessibility-check, integration-tests]
    if: always()
    
    steps:
    - name: üìà –û–±—â–∞—è —Å–≤–æ–¥–∫–∞
      run: |
        echo "## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CI/CD –ø—Ä–æ–≤–µ—Ä–æ–∫"
        echo ""
        echo "### ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:"
        
        if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "- üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        fi
        
        if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "- üìù –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞"
        fi
        
        if [[ "${{ needs.dependencies-check.result }}" == "success" ]]; then
          echo "- üõ†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        fi
        
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "- üß™ Unit —Ç–µ—Å—Ç—ã (167+ —Ç–µ—Å—Ç–æ–≤: Schema + FAQ + Smile Products + Multiple Comments + Aggregated Schema + Admin + CI + Order Products Structure + 1C Notify Update Validation + HTTP/Mocks)"
        fi
        
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "- üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã 1C (15+ —Ç–µ—Å—Ç–æ–≤: –ü–æ–ª–Ω—ã–π workflow + HTTP + –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)"
        fi
        
        if [[ "${{ needs.performance-check.result }}" == "success" ]]; then
          echo "- üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
        fi
        
        if [[ "${{ needs.accessibility-check.result }}" == "success" ]]; then
          echo "- ‚ôø –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"
        fi
        
        echo ""
        echo "### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:"
        
        FAILED_JOBS=()
        
        if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
          FAILED_JOBS+=("security-scan")
        fi
        
        if [[ "${{ needs.code-quality.result }}" == "failure" ]]; then
          FAILED_JOBS+=("code-quality")
        fi
        
        if [[ "${{ needs.dependencies-check.result }}" == "failure" ]]; then
          FAILED_JOBS+=("dependencies-check")
        fi
        
        if [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
          FAILED_JOBS+=("unit-tests")
        fi
        
        if [[ "${{ needs.performance-check.result }}" == "failure" ]]; then
          FAILED_JOBS+=("performance-check")
        fi
        
        if [[ "${{ needs.accessibility-check.result }}" == "failure" ]]; then
          FAILED_JOBS+=("accessibility-check")
        fi
        
        if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
          FAILED_JOBS+=("integration-tests")
        fi
        
        if [[ ${#FAILED_JOBS[@]} -eq 0 ]]; then
          echo "‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º"
          echo ""
          echo "### üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        else
          for job in "${FAILED_JOBS[@]}"; do
            echo "- ‚ùå $job"
          done
          echo ""
          echo "### üî¥ –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã"
        fi
        
        echo ""
        echo "---"
        echo "üìÖ –î–∞—Ç–∞: $(date)"
        echo "üîó Commit: ${{ github.sha }}"
        echo "üåø Branch: ${{ github.ref_name }}"
