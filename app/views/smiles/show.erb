<%
  # –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤:
  # 1. –ï—Å–ª–∏ —É –æ—Ç–∑—ã–≤–∞ –µ—Å—Ç—å order_eight_digit_id - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
  # 2. –ï—Å–ª–∏ –Ω–µ—Ç - fallback –∫ json_order (—Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞)
  # 3. –ú–µ—Ç–æ–¥ @post.products_data —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö

  access = false
  if current_account
    if current_account.id == 171; access = true; end;
  end

  @post = Smile.find(@id)

%>

<%
if @pid
  pr = Product.find_by_id(@pid)
  back_url = '<a href="/smiles/'+@pid+'" style="cursor:pointer;color:#3a4f10;">–°–º–æ—Ç—Ä–µ—Ç—å —Ñ–æ—Ç–æ –¥–æ—Å—Ç–∞–≤–æ–∫ "'+pr.header+'"</a><br />'
  link1 = '/smiles/product/' + @pid.to_s + '/' + @p_next.to_s
  link2 = '/smiles/product/' + @pid.to_s + '/' + @p_prev.to_s
else
  link1 = '/smiles/' + @p_next.to_s
  link2 = '/smiles/' + @p_prev.to_s
end
%>

<% begin
  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö (—Å fallback –∫ json_order)
  products_data = @post.products_data
  x = products_data['0']
  
  if x
    prdct_id = x['id'].to_i;
    cmplct_title = x['complect'];
    prdct = Product.find_by_id(prdct_id)
    
    if prdct && Complect.find_by_title(cmplct_title)
      cmplct_price = prdct.get_cmplct_price_by_title(cmplct_title, @subdomain.discount_pool_id)
      cmplct_header = Complect.find_by_title(cmplct_title).header
    elsif prdct && prdct.complects.any?
      cmplct_title = prdct.complects[0].title
      cmplct_price = prdct.get_cmplct_price_by_title(cmplct_title, @subdomain.discount_pool_id)
      cmplct_header = Complect.find_by_title(cmplct_title).header
    else
      # Fallback values when product is not found
      prdct = nil
      cmplct_title = 'standard'
      cmplct_price = x.has_key?('price') ? x['price'].to_i : 0
      cmplct_header = x.has_key?('title') ? x['title'] : '–ë—É–∫–µ—Ç —Ü–≤–µ—Ç–æ–≤'
    end
  else
    # –ü–æ–ª–Ω—ã–π fallback –∫–æ–≥–¥–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    prdct = nil
    prdct_id = 0
    cmplct_title = 'standard'
    cmplct_price = 0
    cmplct_header = '–ë—É–∫–µ—Ç —Ü–≤–µ—Ç–æ–≤'
  end
rescue StandardError => e
  # Set fallback values on error
  prdct = nil
  prdct_id = 0
  cmplct_title = 'standard'
  cmplct_price = 0
  cmplct_header = '–ë—É–∫–µ—Ç —Ü–≤–µ—Ç–æ–≤'
end %>

<%
  # –ú–∏–∫—Ä–æ—Ä–∞–∑–º–µ—Ç–∫–∞ Review - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
  @related_comment = @post.related_comment
  # Debug info
  puts "DEBUG: Smile #{@post.id}, order_eight_digit_id: #{@post.order_eight_digit_id}"
  puts "DEBUG: Related comment found: #{@related_comment ? @related_comment.id : 'none'}"
  puts "DEBUG: has_review_comment?: #{@post.has_review_comment?}"
%>

<% if @post.has_review_comment? && @related_comment %>
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Review",
    "author": {
      "@type": "Person",
      "name": "<%=@related_comment.name.present? ? @related_comment.name : @post.customer_name%>"
    },
    "datePublished": "<%=(@related_comment.created_at || @post.created_at).strftime('%Y-%m-%d')%>",
    "reviewBody": "<%=h(@related_comment.body)%>",
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": "<%=@related_comment.rating || @post.rating || 5%>",
      "bestRating": "5"
    },
    "itemReviewed": {
      "@type": "Product",
      "name": "<%=begin; @post.review_item_name || (prdct ? prdct.header : cmplct_header); rescue; prdct ? prdct.header : cmplct_header; end%>",
      "image": "<%=begin; @post.review_item_image || (prdct ? prdct.thumb_image(true) : '/images/default-product.jpg'); rescue; prdct ? prdct.thumb_image(true) : '/images/default-product.jpg'; end%>"
    }
  }
</script>
<% end %>

<%
  # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫
  current_protocol = request.env['HTTP_X_FORWARDED_PROTO'] || (request.env['HTTPS'] ? 'https' : 'http')
  current_host = request.env['HTTP_HOST']
  base_url = "#{current_protocol}://#{current_host}"
  
  # URL —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  current_url = "#{base_url}/smiles/#{@post.slug || @post.id}"
  
  # –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º title –±–µ–∑ –¥–∞—Ç—ã)
  page_title = @post.title.to_s.gsub(/\s*\|\s*\d{4}-\d{2}-\d{2}\s*$/, '').strip
  page_title = "–§–æ—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏" if page_title.empty?
%>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "–ì–ª–∞–≤–Ω–∞—è",
      "item": "<%=base_url%>/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "–£–ª—ã–±–∫–∏",
      "item": "<%=base_url%>/smiles/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "<%=page_title%>",
      "item": "<%=current_url%>"
    }
  ]
}
</script>

<%
  # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è WebPage —Ä–∞–∑–º–µ—Ç–∫–∏
  product_name = prdct ? prdct.header : cmplct_header
  webpage_name = "–£–ª—ã–±–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π ‚Äì #{product_name}"
  
  # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
  customer_name = @post.customer_name
  date_str = @post.created_at.strftime('%d %B %Y').gsub('January', '—è–Ω–≤–∞—Ä—è').gsub('February', '—Ñ–µ–≤—Ä–∞–ª—è').gsub('March', '–º–∞—Ä—Ç–∞').gsub('April', '–∞–ø—Ä–µ–ª—è').gsub('May', '–º–∞—è').gsub('June', '–∏—é–Ω—è').gsub('July', '–∏—é–ª—è').gsub('August', '–∞–≤–≥—É—Å—Ç–∞').gsub('September', '—Å–µ–Ω—Ç—è–±—Ä—è').gsub('October', '–æ–∫—Ç—è–±—Ä—è').gsub('November', '–Ω–æ—è–±—Ä—è').gsub('December', '–¥–µ–∫–∞–±—Ä—è')
  
  if customer_name && customer_name.present? && customer_name.strip != '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'
    webpage_description = "–§–æ—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –±—É–∫–µ—Ç–∞ ¬´#{product_name}¬ª –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ #{customer_name} –æ—Ç #{date_str}"
  else
    webpage_description = "–§–æ—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –±—É–∫–µ—Ç–∞ ¬´#{product_name}¬ª –æ—Ç #{date_str}"
  end
%>

<%# Enhanced WebPage schema using helper %>
<% 
  breadcrumbs = [
    { name: "–ì–ª–∞–≤–Ω–∞—è", url: "#{request.base_url}/" },
    { name: "–û—Ç–∑—ã–≤—ã", url: "#{request.base_url}/smiles" },
    { name: webpage_name, url: current_url }
  ]
  
  webpage_options = {
    name: webpage_name,
    description: webpage_description,
    url: current_url,
    date_published: @post.created_at.strftime('%Y-%m-%d'),
    date_modified: @post.updated_at ? @post.updated_at.strftime('%Y-%m-%d') : @post.created_at.strftime('%Y-%m-%d'),
    breadcrumbs: breadcrumbs,
    website_name: "–†–æ–∑–∞—Ä–∏–æ –¶–≤–µ—Ç—ã"
  }
%>
<%= webpage_schema(webpage_options) %>

<%# <div style="height: 44px" class="hidden-xs hidden-sm"></div> %>
<section class="post-detail">
  <div>
    <div class="img-box" style="position: relative;">
      <%
        # –õ–æ–≥–∏–∫–∞ –¥–ª—è alt-–∞—Ç—Ä–∏–±—É—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        alt_text = if @post.alt && @post.alt.present? && @post.alt.strip.length > 0
                     process_smile_alt(@post)
                   else
                     # –ü–æ–ª—É—á–∞–µ–º eight_digit_id –∑–∞–∫–∞–∑–∞ –¥–ª—è fallback
                     order_eight_digit_id = nil
                     begin
                       if @post.json_order.present?
                         order_data = JSON.parse(@post.json_order)
                         first_item = order_data['0']
                         if first_item && first_item['id']
                           order_id = first_item['id'].to_i
                           if order_id > 0
                             matching_order = Order.find_by_id(order_id) || Order.find_by_eight_digit_id(order_id)
                             order_eight_digit_id = matching_order.eight_digit_id if matching_order
                           end
                         end
                       end
                     rescue => e
                       # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ order_eight_digit_id –æ—Å—Ç–∞–Ω–µ—Ç—Å—è nil
                     end
                     
                     # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: customer_name -> eight_digit_id
                     customer_name = @post.customer_name
                     product_name_for_alt = prdct ? prdct.header : cmplct_header
                     if customer_name && customer_name.present? && customer_name.strip != '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'
                       "–§–æ—Ç–æ –±—É–∫–µ—Ç–∞ ¬´#{product_name_for_alt}¬ª –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ #{customer_name}"
                     elsif order_eight_digit_id
                       "–§–æ—Ç–æ –±—É–∫–µ—Ç–∞ ¬´#{product_name_for_alt}¬ª. –ó–∞–∫–∞–∑ ‚Ññ #{order_eight_digit_id}"
                     else
                       "–§–æ—Ç–æ –±—É–∫–µ—Ç–∞ ¬´#{product_name_for_alt}¬ª"
                     end
                   end
      %>
      <%= smile_image_schema(@post, alt_text) %>
      <img class="animated" alt="<%=alt_text%>" src="<%='/uploads/smiles/'+@post.images_identifier%>" onclick="//location.href = '/smiles/<%=@p_prev%>/'" />
      <div id="qar_l"><img class="transition" id="ar_l" src="/images/arrow/ar_l.png" /></div>
      <div id="qar_r"><img class="transition" id="ar_r" src="/images/arrow/ar_r.png" /></div>
      <%#<div class="ttlll">%>
        <%#<h2 style="color:#FFF">%><%#=@post.date%><%#</h2>%>
      <%#</div>%>
      <a href="<%=link1%>" style="display: block; position: absolute; top: 0; bottom: 0; right: 0; left: 25%;"></a>
      <a href="<%=link2%>" style="display: block; position: absolute; top: 0; bottom: 0; right: 75%; left: 0;"></a>
    </div>
    <h1>
      <%=process_smile_title(@post)%>
    </h1>
    <div align="left" style="font-size: 12px; padding-bottom: 24px;">
      <%if back_url%><%=back_url%><%end%>
      <a href="/smiles/" style="cursor:pointer;color:#3a4f10;">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –¥–æ—Å—Ç–∞–≤–æ–∫</a>
    </div>
    <%=process_smile_body(@post) %>
    <style type="text/css">
      #order    { width: 100%; margin-bottom: 24px; font-size: 16px; }
      #order td { padding: 24px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
      #order td img { width: 150px; }
    </style>
    <table id="order">
      <% @post.products_data.each { |item| %>
        <%
          skip = false
          begin
            prdct_id = item[1]['id'].to_i;
            cmplct_title = item[1]['complect'];
            prdct = Product.find_by_id(prdct_id)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ —Ç–æ–≤–∞—Ä–∞ (–∏–∑ order_data)
            if item[1].has_key?('product_exists')
              # –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ order_products
              unless item[1]['product_exists']
                # –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–∫–∞–∑–∞
                prdct = nil
              end
              cmplct_price = item[1]['price'].to_i
              cmplct_header = item[1]['title']
              
              # –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–ª–µ–∫—Ç–µ
              if prdct && Complect.find_by_title(cmplct_title)
                complect = Complect.find_by_title(cmplct_title)
                cmplct_header = complect.header
                # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–Ω—É –∏–∑ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
                # cmplct_price = prdct.get_cmplct_price_by_title(cmplct_title, @subdomain.discount_pool_id)
              end
            else
              # –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞: json_order
              if Complect.find_by_title(cmplct_title)
                cmplct_price = prdct.get_cmplct_price_by_title(cmplct_title, @subdomain.discount_pool_id)
                cmplct_header = Complect.find_by_title(cmplct_title).header
              else
                cmplct_title = Product.find(prdct_id).complects[0].title
                cmplct_price = prdct.get_cmplct_price_by_title(cmplct_title, @subdomain.discount_pool_id)
                cmplct_header = Complect.find_by_title(cmplct_title).header
              end
            end
          rescue StandardError => e
            skip = true
          end
        %>
        <% if !skip %><tr>
          <%= product_image_schema(prdct, true) if prdct %>
          <td width="100">
            <% if prdct %>
              <a href="/product/<%=prdct_id%>"><%=image_tag(prdct.thumb_image(true), itemprop: "image")%></a>
            <% else %>
              <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ -->
              <div style="width: 100px; height: 100px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">
                –ù–µ—Ç —Ñ–æ—Ç–æ
              </div>
            <% end %>
          </td>
          <td style="padding-left: 24px;" itemscope itemtype="https://schema.org/Product">
            <% if prdct %>
              <h3 itemprop="name" style="margin:0"><a href="/product/<%=prdct_id%>"><%=prdct.header%></a></h3>
              <span itemprop="description"><%=cmplct_header%></span>
              <div>
                <% @rating = prdct.rating.to_i %>
                <%= render "partials/_rating", :handlers => [:haml], layout: false %>
              </div>
              <div itemprop="offers" itemscope itemtype="https://schema.org/Offer" style="display:none;">
                <span itemprop="price"><%=cmplct_price%></span>
                <span itemprop="priceCurrency">RUB</span>
              </div>
            <% else %>
              <h3 style="margin:0; color: #999;"><%=cmplct_header%></h3>
              <span style="color: #666; font-style: italic;">–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</span>
            <% end %>
          </td>
          <td align="right" style="white-space:nowrap"><%=cmplct_price%> —Ä.</td>
        </tr><% end %>
      <% } %>
    </table>
    
    <!-- –ë–ª–æ–∫ —Å –æ—Ç–∑—ã–≤–æ–º –∫–ª–∏–µ–Ω—Ç–∞ -->
    <% if @post.has_review_comment? && @related_comment %>
      <%
        comment_author = @related_comment.name.present? ? @related_comment.name : (@post.customer_name || '–ö–ª–∏–µ–Ω—Ç')
        comment_date = @related_comment.date || @related_comment.created_at
        comment_rating = @related_comment.rating || @post.rating || 5
      %>
      <div style="margin: 32px 0; padding: 24px; background: #f9f9f9; border-left: 4px solid #4CAF50; border-radius: 4px;">
        <h3 style="margin: 0 0 16px 0; color: #2c3e50; font-size: 18px;">üí¨ –û—Ç–∑—ã–≤ –∫–ª–∏–µ–Ω—Ç–∞</h3>
        
        <div style="margin-bottom: 16px; display: flex; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div style="font-weight: bold; color: #34495e;">
            üë§ <%= comment_author %>
          </div>
          <% if comment_date %>
            <div style="color: #7f8c8d; font-size: 14px;">
              üìÖ <%= comment_date.strftime('%d.%m.%Y') %>
            </div>
          <% end %>
          <% if comment_rating && comment_rating > 0 %>
            <div style="display: flex; align-items: center;">
              <span style="margin-right: 8px; color: #7f8c8d;">–û—Ü–µ–Ω–∫–∞:</span>
              <% @rating = comment_rating.to_i %>
              <%= render "partials/_rating", :handlers => [:haml], layout: false %>
            </div>
          <% end %>
        </div>
        
        <% if @related_comment.title && @related_comment.title.present? %>
          <h4 style="margin: 0 0 12px 0; color: #34495e; font-size: 16px; font-weight: 600;">
            <%= h(@related_comment.title) %>
          </h4>
        <% end %>
        
        <div style="color: #2c3e50; line-height: 1.6; font-size: 15px;">
          <%= h(@related_comment.body).gsub("\n", "<br>").html_safe %>
        </div>
        
        <% if @post.order_eight_digit_id %>
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd; font-size: 13px; color: #7f8c8d;">
            üì¶ –ó–∞–∫–∞–∑ ‚Ññ <%= @post.order_eight_digit_id %>
          </div>
        <% end %>
      </div>
    <% end %>
    <!-- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ —Å –æ—Ç–∑—ã–≤–æ–º -->
    
    <div align="center" style="padding-bottom: 24px;">
      <a href="/" class="btn" style="cursor:pointer;font-size:16px;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥ –±—É–∫–µ—Ç–æ–≤</a>
    </div>
  </div>

</section>

<%#<script type="text/javascript">
$(window).load(function() {
  function scrollToElement(theElement) {
    var selectedPosX = 0,
        selectedPosY = 0;
    while (theElement != null) {
      selectedPosX += theElement.offsetLeft;
      selectedPosY += theElement.offsetTop;
      theElement = theElement.offsetParent;
    }
    window.scrollTo(selectedPosX,selectedPosY);
  }
  var mainnn = document.getElementById('mainnn');
  scrollToElement(mainnn);
  setTimeout(function() {
    scrollToElement(mainnn);
  }, 10);
});
</script>%>

<!-- –ú–∏–∫—Ä–æ—Ä–∞–∑–º–µ—Ç–∫–∞ Review —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->