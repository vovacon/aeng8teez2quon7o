-# encoding: utf-8
-# Финальная версия мобильной панели корзины
- if !session[:cart].nil? && !session[:cart].empty?
  - total_items = session[:cart].sum { |item| item["quantity"].to_i }
  - total_sum = 0
  - session[:cart].each do |item|
    - product = Product.find_by_id(item["id"])
    - if product
      - complect = Complect.find_by_title(item["type"]) || Complect.find_by_title("standard")
      - complect_id = complect ? complect.id : 1
      - product_complect = ProductComplect.where(product_id: product.id, complect_id: complect_id).first
      - if product_complect
        - total_sum += product_complect.price * item["quantity"].to_i
  
  .mobile-cart-panel#mobile-cart-panel
    .mobile-cart-panel__content
      .mobile-cart-panel__items-count
        %span.mobile-cart-panel__count-badge#cart-count-badge= total_items
      
      %a.mobile-cart-panel__cart-button{ href: "/cart" }
        Перейти в корзину
      
      .mobile-cart-panel__total-price
        %span.mobile-cart-panel__price#cart-total-price= "#{total_sum.round} ₽"
  
  -# Дополнительный блок для заполнения области под панелью на iPhone
  .mobile-cart-panel-filler#cart-panel-filler

:css
  .mobile-cart-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 76px;
    background-color: #fff;
    border-top: 1px solid #ddd;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    display: none; /* Скрыта по умолчанию */
    align-items: center;
    padding: 0 16px;
    /* Для iPhone - заполняем пустое пространство снизу */
    padding-bottom: env(safe-area-inset-bottom, 0);
    min-height: calc(76px + env(safe-area-inset-bottom, 0));
  }
  
  /* Фиксированный блок-заполнитель для iPhone - заполняет пространство под панелью */
  .mobile-cart-panel-filler {
    position: fixed;
    bottom: calc(-1 * env(safe-area-inset-bottom, 0) - 50px); /* Позиционируем под панелью */
    left: 0;
    right: 0;
    height: calc(50px + env(safe-area-inset-bottom, 0)); /* Достаточно высокий */
    background-color: #fff;
    z-index: 9998; /* Ниже панели */
    display: none; /* По умолчанию скрыт */
  }

  .mobile-cart-panel__content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    max-width: 100%;
  }

  .mobile-cart-panel__items-count {
    display: flex;
    align-items: center;
    margin-right: 12px;
  }

  .mobile-cart-panel__count-badge {
    background-color: #ff4757;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 13px;
    font-weight: bold;
    line-height: 25px;
    text-align: center;
    display: block;
    box-sizing: border-box;
  }

  .mobile-cart-panel__cart-button {
    flex: 1;
    text-align: center;
    background-color: #ef845b;
    color: white;
    height: 40px;
    line-height: 40px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    margin: 0 12px;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .mobile-cart-panel__cart-button:hover {
    background-color: #e6744a;
    color: white;
    text-decoration: none;
  }

  .mobile-cart-panel__total-price {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
  }

  .mobile-cart-panel__price {
    color: #e74c3c;
    font-size: 16px;
  }

  /* Показываем на экранах меньше 1024px и только НЕ на страницах корзины */
  @media (max-width: 1023px) {
    .mobile-cart-panel {
      display: flex !important;
    }
    
    /* Скрываем на страницах корзины */
    body[data-page-cart] .mobile-cart-panel {
      display: none !important;
    }
    
    /* Дополнительное правило для страниц корзины */
    .mobile-cart-panel[data-cart-page="true"] {
      display: none !important;
    }
    
    /* Добавляем отступ снизу для body с учетом safe area */
    body:not([data-page-cart]) {
      padding-bottom: calc(76px + env(safe-area-inset-bottom, 0));
    }
    
    /* Показываем заполнитель только на мобильных экранах */
    .mobile-cart-panel-filler {
      display: none;
    }
  }

  @media (min-width: 1024px) {
    .mobile-cart-panel {
      display: none !important;
    }
  }

:javascript
  // Глобальная функция для управления позицией чата TalkMe
  window.updateChatPosition = function(showPanel) {
    // Найдём стиль TalkMe или создадим новый
    let chatStyle = document.getElementById('TalkMe_online-chat-trigger');
    if (!chatStyle) {
      chatStyle = document.createElement('style');
      chatStyle.id = 'TalkMe_online-chat-trigger';
      document.head.appendChild(chatStyle);
    }
    
    const bottomValue = showPanel ? '116px' : '40px'; // 76px панель + 40px отступ = 116px
    chatStyle.textContent = `.online-chat-root-TalkMe #supportTrigger {bottom: ${bottomValue} !important; right: 150px !important;}`;
    
    console.log('Chat position updated:', bottomValue);
    
    // Дополнительно проверяем сам элемент
    const supportTrigger = document.getElementById('supportTrigger');
    if (supportTrigger) {
      supportTrigger.style.bottom = bottomValue + ' !important';
      console.log('Chat trigger element directly updated:', bottomValue);
    }
  };
  
  // Функция поиска и позиционирования чата
  window.findAndPositionChat = function() {
    const cartPanel = document.getElementById('mobile-cart-panel');
    const supportTrigger = document.getElementById('supportTrigger');
    
    if (supportTrigger && cartPanel) {
      const panelVisible = window.getComputedStyle(cartPanel).display === 'flex';
      const isMobile = window.innerWidth < 1024;
      const shouldPositionChat = panelVisible && isMobile;
      
      window.updateChatPosition(shouldPositionChat);
      
      // Отмечаем, что чат уже позиционирован
      if (!supportTrigger.hasAttribute('data-cart-positioned')) {
        supportTrigger.setAttribute('data-cart-positioned', 'true');
      }
      
      console.log('Chat found and positioned:', shouldPositionChat ? '116px' : '40px', 'Mobile:', isMobile, 'Panel visible:', panelVisible);
      return true;
    }
    
    return false;
  };

  document.addEventListener('DOMContentLoaded', function() {
    const cartPanel = document.getElementById('mobile-cart-panel');
    const cartFiller = document.getElementById('cart-panel-filler');
    
    // Функция обновления панели через AJAX
    function updateCartPanel() {
      fetch('/cart/stat?_=' + Date.now(), {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      })
      .then(response => response.json())
      .then(data => {
        const countBadge = document.getElementById('cart-count-badge');
        const totalPrice = document.getElementById('cart-total-price');
        
        if (countBadge && data.total_q !== undefined) {
          countBadge.textContent = data.total_q;
        }
        if (totalPrice && data.total_s !== undefined) {
          totalPrice.textContent = Math.round(data.total_s) + ' ₽';
        }
        
        // Показываем/скрываем панель в зависимости от наличия товаров
        const hasItems = (data.total_q || 0) > 0;
        const currentPath = window.location.pathname;
        const currentUrl = window.location.href;
        const isCartPage = currentPath.startsWith('/cart') || currentUrl.includes('/cart');
        
        // Отладочная информация
        console.log('Cart Panel Debug:', {
          hasItems: hasItems,
          currentPath: currentPath,
          currentUrl: currentUrl,
          isCartPage: isCartPage,
          screenWidth: window.innerWidth,
          shouldShow: hasItems && !isCartPage && window.innerWidth < 1024
        });
        


        if (cartPanel) {
          if (hasItems && !isCartPage && window.innerWidth < 1024) {
            console.log('Showing cart panel');
            cartPanel.style.display = 'flex';
            cartPanel.removeAttribute('data-cart-page');
            document.body.style.paddingBottom = 'calc(76px + env(safe-area-inset-bottom, 0))';
            // Показываем заполнитель только на iOS устройствах
            if (cartFiller && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
              cartFiller.style.display = 'block';
            }
            // Поднимаем чат над панелью
            window.updateChatPosition(true);
          } else {
            console.log('Hiding cart panel - Reason:', !hasItems ? 'no items' : isCartPage ? 'cart page' : 'desktop');
            cartPanel.style.display = 'none';
            if (isCartPage) cartPanel.setAttribute('data-cart-page', 'true');
            document.body.style.paddingBottom = '0';
            // Скрываем заполнитель
            if (cartFiller) {
              cartFiller.style.display = 'none';
            }
            // Возвращаем чат в обычное положение
            window.updateChatPosition(false);
          }
        }
      })
      .catch(error => {
        console.warn('Cart panel update failed:', error);
      });
    }
    
    if (cartPanel) {
      // Начальное обновление
      updateCartPanel();
      
      // Простая и надёжная инициализация позиции чата
      // Пробуем найти чат немедленно
      setTimeout(() => window.findAndPositionChat(), 100);
      
      // Повторные попытки с задержками
      setTimeout(() => window.findAndPositionChat(), 500);
      setTimeout(() => window.findAndPositionChat(), 1000);
      setTimeout(() => window.findAndPositionChat(), 2000);
      setTimeout(() => window.findAndPositionChat(), 3000);
      
      // Обновляем при изменении размера окна
      window.addEventListener('resize', function() {
        setTimeout(() => {
          updateCartPanel();
          window.findAndPositionChat(); // Перепозиционируем чат
        }, 100);
      });
      
      // Обновляем при кликах по ссылкам добавления в корзину
      document.addEventListener('click', function(e) {
        const target = e.target.closest('a[href*="/cart/add/"], a[href*="/add-to-cart/"]');
        if (target) {
          setTimeout(() => {
            updateCartPanel();
            window.findAndPositionChat(); // Перепозиционируем чат
          }, 1000);
        }
      });
      
      // Обновляем при отправке форм добавления в корзину
      document.addEventListener('submit', function(e) {
        const form = e.target;
        if (form.action && (form.action.includes('/cart/add/') || form.action.includes('/add-to-cart/'))) {
          setTimeout(() => {
            updateCartPanel();
            window.findAndPositionChat(); // Перепозиционируем чат
          }, 1000);
        }
      });
      
      // Периодическое обновление (каждые 30 секунд)
      setInterval(updateCartPanel, 30000);
      
      // Простая периодическая проверка чата (первые 5 секунд)
      let chatFoundCount = 0;
      const chatCheckInterval = setInterval(() => {
        if (window.findAndPositionChat()) {
          chatFoundCount++;
          // Прекращаем поиск после 2 успешных позиционирований
          if (chatFoundCount >= 2) {
            clearInterval(chatCheckInterval);
            console.log('Chat positioning checks completed successfully');
          }
        }
      }, 1000); // Каждую секунду
      
      // Стоп проверок через 5 секунд
      setTimeout(() => {
        clearInterval(chatCheckInterval);
        console.log('Chat positioning checks timeout - stopped');
      }, 5000);
    }
    
    // Наблюдатель за появлением чата TalkMe (упрощённый)
    const chatObserver = new MutationObserver(function(mutations) {
      // Просто вызываем нашу функцию поиска
      if (window.findAndPositionChat()) {
        console.log('TalkMe chat detected via MutationObserver');
      }
    });
    
    // Начинаем наблюдение за изменениями в DOM
    chatObserver.observe(document.body, { childList: true, subtree: true });
    
    // Финальные проверки при полной загрузке
    window.addEventListener('load', function() {
      setTimeout(() => {
        window.findAndPositionChat();
        console.log('Final chat positioning attempt on window load');
      }, 1000);
      
      // Ещё одна попытка через 3 секунды
      setTimeout(() => {
        window.findAndPositionChat();
        console.log('Last resort chat positioning attempt');
      }, 3000);
    });
    
    console.log('Mobile cart panel with AJAX updates and enhanced chat positioning loaded');
  });
